name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: flask-app

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    name: Run Unit Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        python -m pytest test_app.py -v

  integration-tests:
    runs-on: ubuntu-latest
    name: Run Integration Tests
    # This runs in parallel with unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run integration tests
      run: |
        # Add any integration tests here
        echo "Running integration tests..."

  build:
    runs-on: ubuntu-latest
    name: Build Docker Image
    needs: [unit-tests, integration-tests]  # Wait for both test jobs
    
    steps:
    - name: Checkout code  
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t $IMAGE_NAME .

  push-to-registries:
    runs-on: ubuntu-latest
    name: Push to Docker Registries
    needs: build
    if: github.ref == 'refs/heads/main' && success()  # Only run on main branch if previous steps succeeded
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t $IMAGE_NAME .
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Push to Docker Hub
      run: |
        docker tag $IMAGE_NAME ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:latest
    
    - name: Push to GitHub Container Registry (example)
      run: |
        docker tag $IMAGE_NAME ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:latest
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:latest
      
  notify-on-failure:
    runs-on: ubuntu-latest
    name: Notify on Failure
    if: failure()  # Only run if previous jobs failed
    needs: [unit-tests, integration-tests, build]
    
    steps:
    - name: Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ðŸš¨ CI Pipeline Failed - ${{ github.repository }}"
        body: |
          The CI pipeline for ${{ github.repository }} has failed.
          
          Workflow: ${{ github.workflow }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref }}
          Triggered by: ${{ github.actor }}
          
          Please check the GitHub Actions logs for details: 
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        to: ${{ secrets.EMAIL_TO }}
        from: "GitHub Actions <${{ secrets.EMAIL_FROM }}>"
        content_type: "text/html"
